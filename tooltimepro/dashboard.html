<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | ToolTime Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --navy: #1a1a2e;
            --navy-light: #252542;
            --gold: #f5a623;
            --gold-light: #ffc857;
            --success: #00c853;
            --warning: #ffab00;
            --danger: #ff5252;
            --info: #2196f3;
            --text: #e8e8e8;
            --text-muted: #a0a0b0;
            --border: #3a3a5a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--navy);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--navy-light);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .back-link {
            color: var(--gold);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.2s;
        }

        .back-link:hover { opacity: 0.8; }

        .header-title h1 { font-size: 1.5rem; font-weight: 700; color: white; }
        .header-title p { font-size: 0.875rem; color: var(--text-muted); margin-top: 4px; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--navy);
        }

        .user-name {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .company-name {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Stats Row */
        .stats-section {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .stat-card {
            background: var(--navy-light);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.revenue { background: rgba(0, 200, 83, 0.15); }
        .stat-icon.jobs { background: rgba(33, 150, 243, 0.15); }
        .stat-icon.workers { background: rgba(245, 166, 35, 0.15); }
        .stat-icon.leads { background: rgba(255, 82, 82, 0.15); }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
            margin-top: 8px;
        }

        .stat-change.up { background: rgba(0, 200, 83, 0.15); color: var(--success); }
        .stat-change.neutral { background: rgba(33, 150, 243, 0.15); color: var(--info); }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--navy) 25%, var(--navy-light) 50%, var(--navy) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-text {
            height: 2rem;
            width: 80px;
        }

        .skeleton-line {
            height: 1rem;
            width: 100%;
            margin-bottom: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Main Dashboard Grid */
        .dashboard-grid {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 24px 24px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 24px;
        }

        /* Panel */
        .panel {
            background: var(--navy-light);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-badge {
            background: var(--gold);
            color: var(--navy);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .panel-body {
            padding: 16px 20px;
            max-height: 450px;
            overflow-y: auto;
        }

        /* Job Items */
        .job-item {
            display: flex;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .job-item:hover {
            background: rgba(245, 166, 35, 0.05);
            margin: 0 -20px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .job-item:last-child { border-bottom: none; }

        .job-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            width: 70px;
            flex-shrink: 0;
        }

        .job-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: 4px;
            flex-shrink: 0;
        }

        .job-status-dot.scheduled { background: var(--info); }
        .job-status-dot.in_progress { background: var(--warning); animation: pulse 2s infinite; }
        .job-status-dot.completed { background: var(--success); }
        .job-status-dot.cancelled { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .job-details { flex: 1; }

        .job-name {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 2px;
        }

        .job-info {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 6px;
        }

        .status-new { background: #e3f2fd; color: #1565c0; }
        .status-contacted { background: #fff3e0; color: #ef6c00; }
        .status-quoted { background: #f3e5f5; color: #7b1fa2; }
        .status-won { background: #e8f5e9; color: #2e7d32; }
        .status-lost { background: #ffebee; color: #c62828; }

        .status-scheduled { background: rgba(33, 150, 243, 0.15); color: var(--info); }
        .status-active, .status-in_progress { background: rgba(255, 171, 0, 0.15); color: var(--warning); }
        .status-completed { background: rgba(0, 200, 83, 0.15); color: var(--success); }
        .status-cancelled { background: rgba(255, 82, 82, 0.15); color: var(--danger); }

        /* Lead Items */
        .lead-item {
            background: var(--navy);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--gold);
        }

        .lead-item:last-child { margin-bottom: 0; }

        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .lead-name {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .lead-source {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(245, 166, 35, 0.15);
            color: var(--gold);
        }

        .lead-source.hot {
            background: rgba(255, 82, 82, 0.15);
            color: var(--danger);
        }

        .lead-description {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .lead-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .lead-actions {
            display: flex;
            gap: 8px;
        }

        .lead-btn, .btn-icon {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lead-btn.primary { background: var(--gold); color: var(--navy); }
        .lead-btn.secondary { background: var(--navy-light); color: var(--text); border: 1px solid var(--border); }
        .lead-btn:hover, .btn-icon:hover { opacity: 0.9; transform: translateY(-1px); }

        .btn-icon {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        /* Worker Cards */
        .worker-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--navy);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .worker-card:last-child { margin-bottom: 0; }

        .worker-avatar {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(245, 166, 35, 0.15);
            border-radius: 50%;
        }

        .worker-info { flex: 1; }

        .worker-info h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .worker-status {
            font-size: 0.8125rem;
            color: var(--success);
            margin-bottom: 2px;
        }

        .worker-hours {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .worker-job {
            font-size: 0.75rem;
            color: var(--gold);
            margin-top: 4px;
        }

        .worker-actions .btn-sm {
            padding: 6px 12px;
            background: var(--navy-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .worker-actions .btn-sm:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--navy-light);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            border: 1px solid var(--gold);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }

        .toast-notification.show {
            transform: translateX(0);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 32px 24px;
            font-style: italic;
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Quick Actions */
        .quick-actions {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 24px 48px;
        }

        .actions-grid {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 14px 24px;
            background: var(--navy-light);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .action-btn.primary {
            background: var(--gold);
            color: var(--navy);
            border-color: var(--gold);
        }

        .action-btn.primary:hover {
            opacity: 0.9;
        }

        /* Payroll Banner */
        .payroll-banner {
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .payroll-banner-text {
            color: var(--navy);
            font-weight: 600;
            font-size: 0.9375rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .payroll-banner-link {
            background: var(--navy);
            color: var(--gold);
            padding: 8px 18px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .payroll-banner-link:hover {
            background: var(--navy-light);
            transform: translateY(-1px);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 900px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: flex-start; }
            .stats-grid { grid-template-columns: 1fr; }
            .actions-grid { flex-direction: column; }
            .action-btn { justify-content: center; }
        }

        /* Tables for responsive display */
        .jobs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .jobs-table th {
            text-align: left;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .jobs-table td {
            padding: 12px 8px 12px 0;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        .jobs-table tr:last-child td {
            border-bottom: none;
        }

        .jobs-table tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .jobs-table tr:hover {
            background: rgba(245, 166, 35, 0.05);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="back-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to ToolTime Pro
            </a>
            <div class="header-title">
                <h1>Admin Dashboard</h1>
                <p>Your entire business at a glance. Jobs, leads, crew, revenue - all in one place.</p>
            </div>
            <div class="user-info" id="user-info">
                <div class="user-avatar" id="user-avatar">--</div>
                <div>
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="company-name" id="company-name">--</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Payroll Coming Soon Banner -->
    <div class="payroll-banner">
        <span class="payroll-banner-text">Payroll is coming! Direct deposit, tax forms, time sync - all built-in.</span>
        <a href="payroll.html#waitlist" class="payroll-banner-link">Join Waitlist</a>
    </div>

    <!-- Stats Row -->
    <section class="stats-section">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon jobs">üìã</div>
                </div>
                <div class="stat-value" id="today-jobs-count"><span class="skeleton skeleton-text"></span></div>
                <div class="stat-label">Jobs Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon leads">üî•</div>
                </div>
                <div class="stat-value" id="new-leads-count"><span class="skeleton skeleton-text"></span></div>
                <div class="stat-label">New Leads</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon workers">üë∑</div>
                </div>
                <div class="stat-value" id="clocked-in-count"><span class="skeleton skeleton-text"></span></div>
                <div class="stat-label">Workers Clocked In</div>
            </div>
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon revenue">üí∞</div>
                </div>
                <div class="stat-value" id="month-revenue"><span class="skeleton skeleton-text"></span></div>
                <div class="stat-label">Revenue This Month</div>
            </div>
        </div>
    </section>

    <!-- Dashboard Grid -->
    <main class="dashboard-grid">
        <!-- Today's Jobs -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">üìÖ Today's Schedule</div>
                <span class="panel-badge" id="jobs-count-badge">--</span>
            </div>
            <div class="panel-body">
                <div id="jobs-table-body">
                    <div class="skeleton skeleton-line"></div>
                    <div class="skeleton skeleton-line"></div>
                    <div class="skeleton skeleton-line"></div>
                </div>
            </div>
        </div>

        <!-- Leads & CRM -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">üî• Recent Leads</div>
                <span class="panel-badge" id="leads-count-badge">--</span>
            </div>
            <div class="panel-body">
                <div id="leads-table-body">
                    <div class="skeleton skeleton-line"></div>
                    <div class="skeleton skeleton-line"></div>
                    <div class="skeleton skeleton-line"></div>
                </div>
            </div>
        </div>

        <!-- Crew Status -->
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">üë∑ Clocked In Now</div>
            </div>
            <div class="panel-body">
                <div id="workers-container">
                    <div class="skeleton skeleton-line"></div>
                    <div class="skeleton skeleton-line"></div>
                    <div class="skeleton skeleton-line"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Quick Actions -->
    <section class="quick-actions">
        <div class="actions-grid">
            <button class="action-btn primary" onclick="window.location.href='scheduler.html'">
                <span>+</span> New Job
            </button>
            <button class="action-btn" onclick="window.location.href='quote.html'">
                <span>üìÑ</span> New Quote
            </button>
            <button class="action-btn" onclick="window.location.href='workers.html'">
                <span>üë§</span> Add Worker
            </button>
            <button class="action-btn" onclick="window.location.href='reports.html'">
                <span>üìä</span> Reports
            </button>
            <button class="action-btn" onclick="window.location.href='settings.html'">
                <span>‚öôÔ∏è</span> Settings
            </button>
        </div>
    </section>

    <script>
        // ============================================
        // SUPABASE CONNECTION
        // ============================================
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'
        const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Global variables
        let currentUser = null
        let companyId = null

        // ============================================
        // AUTH CHECK (on page load)
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { user } } = await supabaseClient.auth.getUser()

            if (!user) {
                window.location.href = '/login.html'
                return
            }

            // Get user's company
            const { data: userData, error } = await supabaseClient
                .from('users')
                .select('*, companies(*)')
                .eq('id', user.id)
                .single()

            if (error || !userData) {
                console.error('Error fetching user data:', error)
                window.location.href = '/login.html'
                return
            }

            currentUser = userData
            companyId = userData.company_id

            // Update UI with user info
            document.getElementById('user-name').textContent = userData.name || user.email
            document.getElementById('company-name').textContent = userData.companies?.name || 'My Company'
            document.getElementById('user-avatar').textContent = getInitials(userData.name || user.email)

            // Load dashboard data
            loadDashboardData()

            // Setup real-time subscriptions
            setupRealtimeSubscriptions()
        })

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)
        }

        // ============================================
        // TOP STATS CARDS
        // ============================================
        async function loadDashboardData() {
            const today = new Date().toISOString().split('T')[0]
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString()

            // Card 1: Today's Jobs
            const { count: todayJobs } = await supabaseClient
                .from('jobs')
                .select('*', { count: 'exact', head: true })
                .eq('company_id', companyId)
                .eq('scheduled_date', today)

            document.getElementById('today-jobs-count').textContent = todayJobs || 0

            // Card 2: New Leads (status = 'new')
            const { count: newLeads } = await supabaseClient
                .from('leads')
                .select('*', { count: 'exact', head: true })
                .eq('company_id', companyId)
                .eq('status', 'new')

            document.getElementById('new-leads-count').textContent = newLeads || 0

            // Card 3: Workers Clocked In
            const { count: clockedIn } = await supabaseClient
                .from('time_entries')
                .select('*', { count: 'exact', head: true })
                .eq('company_id', companyId)
                .gte('clock_in', today)
                .is('clock_out', null)

            document.getElementById('clocked-in-count').textContent = clockedIn || 0

            // Card 4: Revenue This Month
            const { data: paidInvoices } = await supabaseClient
                .from('invoices')
                .select('amount')
                .eq('company_id', companyId)
                .eq('status', 'paid')
                .gte('paid_date', startOfMonth)

            const monthRevenue = paidInvoices?.reduce((sum, inv) => sum + parseFloat(inv.amount || 0), 0) || 0
            document.getElementById('month-revenue').textContent = '$' + monthRevenue.toLocaleString()

            // Load tables
            loadTodaysJobs()
            loadRecentLeads()
            loadClockedInWorkers()
        }

        // ============================================
        // TODAY'S JOBS TABLE
        // ============================================
        async function loadTodaysJobs() {
            const today = new Date().toISOString().split('T')[0]

            const { data: jobs, error } = await supabaseClient
                .from('jobs')
                .select(`
                    *,
                    customers(name, address, phone),
                    job_assignments(users(name))
                `)
                .eq('company_id', companyId)
                .eq('scheduled_date', today)
                .order('scheduled_time', { ascending: true })
                .limit(10)

            const container = document.getElementById('jobs-table-body')

            // Update badge
            document.getElementById('jobs-count-badge').textContent = (jobs?.length || 0) + ' jobs'

            if (error) {
                console.error('Error loading jobs:', error)
                container.innerHTML = '<div class="empty-state">Error loading jobs</div>'
                return
            }

            if (!jobs || jobs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>No jobs scheduled today</p>
                    </div>
                `
                return
            }

            container.innerHTML = jobs.map(job => {
                const assignedWorker = job.job_assignments?.[0]?.users?.name || 'Unassigned'
                const statusClass = getStatusClass(job.status)

                return `
                    <div class="job-item" onclick="viewJob('${job.id}')">
                        <div class="job-time">${formatTime(job.scheduled_time)}</div>
                        <div class="job-status-dot ${job.status}"></div>
                        <div class="job-details">
                            <div class="job-name">${escapeHtml(job.title)}</div>
                            <div class="job-info">${escapeHtml(assignedWorker)} &bull; ${escapeHtml(job.customers?.address || 'No address')}</div>
                            <span class="status-badge ${statusClass}">${formatStatus(job.status)}</span>
                        </div>
                    </div>
                `
            }).join('')
        }

        function getStatusClass(status) {
            const classes = {
                'scheduled': 'status-scheduled',
                'in_progress': 'status-active',
                'completed': 'status-completed',
                'cancelled': 'status-cancelled'
            }
            return classes[status] || 'status-scheduled'
        }

        function formatStatus(status) {
            return (status || 'scheduled').replace(/_/g, ' ').toUpperCase()
        }

        function formatTime(time) {
            if (!time) return 'TBD'
            try {
                return new Date('1970-01-01T' + time).toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                })
            } catch (e) {
                return time
            }
        }

        // ============================================
        // RECENT LEADS TABLE
        // ============================================
        async function loadRecentLeads() {
            const { data: leads, error } = await supabaseClient
                .from('leads')
                .select('*')
                .eq('company_id', companyId)
                .order('created_at', { ascending: false })
                .limit(5)

            const container = document.getElementById('leads-table-body')

            // Update badge
            const newLeadsCount = leads?.filter(l => l.status === 'new').length || 0
            document.getElementById('leads-count-badge').textContent = newLeadsCount + ' new'

            if (error) {
                console.error('Error loading leads:', error)
                container.innerHTML = '<div class="empty-state">Error loading leads</div>'
                return
            }

            if (!leads || leads.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üî•</div>
                        <p>No leads yet</p>
                    </div>
                `
                return
            }

            container.innerHTML = leads.map(lead => {
                const statusClass = getLeadStatusClass(lead.status)
                const timeAgo = getTimeAgo(lead.created_at)
                const isHot = lead.status === 'new' && timeAgo.includes('m')

                return `
                    <div class="lead-item">
                        <div class="lead-header">
                            <div class="lead-name">${escapeHtml(lead.name || 'Unknown')}</div>
                            <span class="lead-source ${isHot ? 'hot' : ''}">${isHot ? 'üî• ' : ''}${timeAgo}</span>
                        </div>
                        <div class="lead-description">${escapeHtml(lead.service_type || 'General inquiry')}</div>
                        <div class="lead-meta">
                            ${lead.phone ? `üìû ${escapeHtml(lead.phone)}` : ''}
                            ${lead.source ? `&bull; Via ${escapeHtml(lead.source)}` : ''}
                        </div>
                        <div class="lead-actions">
                            ${lead.phone ? `<button class="lead-btn primary" onclick="callLead('${escapeHtml(lead.phone)}')">üìû Call</button>` : ''}
                            <button class="lead-btn secondary" onclick="createQuote('${lead.id}')">üìù Quote</button>
                            <span class="status-badge ${statusClass}">${escapeHtml(lead.status || 'new')}</span>
                        </div>
                    </div>
                `
            }).join('')
        }

        function getLeadStatusClass(status) {
            const classes = {
                'new': 'status-new',
                'contacted': 'status-contacted',
                'quoted': 'status-quoted',
                'won': 'status-won',
                'lost': 'status-lost'
            }
            return classes[status] || 'status-new'
        }

        function getTimeAgo(dateString) {
            if (!dateString) return 'Unknown'
            const date = new Date(dateString)
            const now = new Date()
            const diffMs = now - date
            const diffMins = Math.floor(diffMs / 60000)
            const diffHours = Math.floor(diffMins / 60)
            const diffDays = Math.floor(diffHours / 24)

            if (diffMins < 60) return `${diffMins}m ago`
            if (diffHours < 24) return `${diffHours}h ago`
            return `${diffDays}d ago`
        }

        // ============================================
        // CLOCKED IN WORKERS
        // ============================================
        async function loadClockedInWorkers() {
            const today = new Date().toISOString().split('T')[0]

            const { data: timeEntries, error } = await supabaseClient
                .from('time_entries')
                .select(`
                    *,
                    users(name, phone),
                    jobs(title, customers(name, address))
                `)
                .eq('company_id', companyId)
                .gte('clock_in', today)
                .is('clock_out', null)

            const container = document.getElementById('workers-container')

            if (error) {
                console.error('Error loading workers:', error)
                container.innerHTML = '<div class="empty-state">Error loading workers</div>'
                return
            }

            if (!timeEntries || timeEntries.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë∑</div>
                        <p>No workers currently clocked in</p>
                    </div>
                `
                return
            }

            container.innerHTML = timeEntries.map(entry => {
                const clockInTime = new Date(entry.clock_in)
                const now = new Date()
                const hoursWorked = ((now - clockInTime) / 3600000).toFixed(1)
                const clockInFormatted = clockInTime.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                })

                return `
                    <div class="worker-card">
                        <div class="worker-avatar">üë∑</div>
                        <div class="worker-info">
                            <h4>${escapeHtml(entry.users?.name || 'Unknown')}</h4>
                            <p class="worker-status">üü¢ Clocked in ${clockInFormatted}</p>
                            <p class="worker-hours">${hoursWorked} hrs worked</p>
                            ${entry.jobs ? `<p class="worker-job">üìç ${escapeHtml(entry.jobs.title)}</p>` : ''}
                        </div>
                        <div class="worker-actions">
                            ${entry.users?.phone ? `<button class="btn-sm" onclick="callWorker('${escapeHtml(entry.users.phone)}')">üìû Call</button>` : ''}
                        </div>
                    </div>
                `
            }).join('')
        }

        // ============================================
        // REAL-TIME SUBSCRIPTIONS
        // ============================================
        function setupRealtimeSubscriptions() {
            // Subscribe to new leads
            supabaseClient
                .channel('leads-changes')
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'leads', filter: `company_id=eq.${companyId}` },
                    (payload) => {
                        showNotification('üî• New lead: ' + (payload.new.name || 'Unknown'))
                        loadRecentLeads()
                        loadDashboardData()
                    }
                )
                .subscribe()

            // Subscribe to time entries (clock in/out)
            supabaseClient
                .channel('time-entries-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'time_entries', filter: `company_id=eq.${companyId}` },
                    (payload) => {
                        if (payload.eventType === 'INSERT') {
                            showNotification('üë∑ Worker clocked in')
                        } else if (payload.eventType === 'UPDATE' && payload.new.clock_out) {
                            showNotification('üë∑ Worker clocked out')
                        }
                        loadClockedInWorkers()
                        loadDashboardData()
                    }
                )
                .subscribe()

            // Subscribe to job changes
            supabaseClient
                .channel('jobs-changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'jobs', filter: `company_id=eq.${companyId}` },
                    (payload) => {
                        loadTodaysJobs()
                        loadDashboardData()
                    }
                )
                .subscribe()
        }

        function showNotification(message) {
            const notification = document.createElement('div')
            notification.className = 'toast-notification'
            notification.innerHTML = message
            document.body.appendChild(notification)

            setTimeout(() => notification.classList.add('show'), 100)
            setTimeout(() => {
                notification.classList.remove('show')
                setTimeout(() => notification.remove(), 300)
            }, 5000)
        }

        // ============================================
        // QUICK ACTIONS
        // ============================================
        function callLead(phone) {
            if (phone) window.location.href = `tel:${phone}`
        }

        function callWorker(phone) {
            if (phone) window.location.href = `tel:${phone}`
        }

        function createQuote(leadId) {
            window.location.href = `/quote.html?lead=${leadId}`
        }

        function viewJob(jobId) {
            window.location.href = `/job.html?id=${jobId}`
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function escapeHtml(text) {
            if (!text) return ''
            const div = document.createElement('div')
            div.textContent = text
            return div.innerHTML
        }
    </script>
</body>
</html>
